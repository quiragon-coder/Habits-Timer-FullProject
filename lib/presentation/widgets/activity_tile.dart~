import 'package:flutter/material.dart';
import 'package:hooks_riverpod/hooks_riverpod.dart';
import '../../infrastructure/db/database.dart';
import '../../application/providers/providers.dart';
import '../pages/activity_detail_page.dart';

class ActivityTile extends ConsumerWidget {
  final Activity activity;
  const ActivityTile({super.key, required this.activity});

  String _mmss(Duration d) {
    final h = d.inHours;
    final m = d.inMinutes.remainder(60);
    final s = d.inSeconds.remainder(60);
    if (h > 0) {
      return '${h.toString().padLeft(2,'0')}:${m.toString().padLeft(2,'0')}:${s.toString().padLeft(2,'0')}';
    }
    return '${m.toString().padLeft(2,'0')}:${s.toString().padLeft(2,'0')}';
  }

  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final totals = ref.watch(totalsProvider(activity.id));
    return ListTile(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
      tileColor: Theme.of(context).cardTheme.color,
      leading: CircleAvatar(
        radius: 22,
        backgroundColor: Theme.of(context).colorScheme.primary.withOpacity(.1),
        child: Text(activity.emoji ?? '⏱️', style: const TextStyle(fontSize: 20)),
      ),
      title: Text(
        activity.name,
        style: Theme.of(context).textTheme.titleMedium?.copyWith(fontWeight: FontWeight.w600),
      ),
      subtitle: totals.when(
        data: (m) => Text("Aujourd'hui: ${_mmss(m['today']!)}", style: Theme.of(context).textTheme.bodySmall?.copyWith(color: Colors.black54)),
        loading: () => Text('Calcul...', style: Theme.of(context).textTheme.bodySmall),
        error: (e, _) => Text('Erreur: $e', style: Theme.of(context).textTheme.bodySmall),
      ),
      trailing: const Icon(Icons.chevron_right),
      onTap: () {
        Navigator.push(
          context,
          MaterialPageRoute(builder: (_) => ActivityDetailPage(activityId: activity.id)),
        );
      },
    );
  }
}
